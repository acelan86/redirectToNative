<!doctype html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>redirectToNative的demo</title>
</head>
<body>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
  <div style="font-size:16px;color:#333">如果没有自动下载，请手动<a style="color:red;font-size:20px" href="http://m.etao.com/download.php?src=unsupport">点此下载一淘客户端</a>，安装后用一淘客户端的扫描功能重新扫描二维码即可；</br></br>如果您不想安装客户端，也可以<a style="color:red;font-size:20px" id="J_gotoH5" href="http://m.etao.com/#item/">直接访问etao触屏版</a>，同样有手机专享价以及优惠券和返利！</div>
<script>
//埋点
function stat() {
  var cnaArr = document.cookie.match(/cna=([\w]+)/i);
  var cna =  cnaArr ? '&cp_cna=' + cnaArr[1] : '';
  var apData = '&ap_data=' + location.search.replace('?', '').replace('=', ':').replace('&',';');
  var url = 'http://log.m.taobao.com/js.do?ap_url=' + encodeURIComponent(window.location.href + '&log=page_scan')
          + apData + cna;
  var img = document.createElement('img');
  img.src = url;
  img.width = '1px';
  img.height = '1px';
  document.body.appendChild(img);
}

//测试发现魅族等不支持etao://item，出降级页面
function dealLink() {
  var nidArr = location.search.match(/nid=([\d]+)/);
  var nid = nidArr ? nidArr[1] : '';
  document.getElementById('J_gotoH5').href = 'http://m.etao.com/#item/' + nid;
}

stat();
dealLink();
/**
 * @fileoverview 
 * @author miaojing<miaojing@taobao.com>
 * @module redirectToNative 移动页面或中间跳转页面使用 不依赖任何kissy模块
 **/

/**
 * @class RedirectToNative
 * @constructor 
 */
var RedirectToNative = {
    init: function(config) {
        var self = this;
            self.platform = self._UA();
        // pc下 什么都不处理  pc访问下可能href可以链接去其他地址
        if(!self.platform) return;
        if (self.platform == 'ios') {
          self.installUrl = config.iosInstallUrl;
          self.nativeUrl = config.iosNativeUrl;
          self.laterTime = config.iosLaterTime || 800;
        } else {
          self.installUrl = config.androidInstallUrl;
          self.nativeUrl = config.andriodNativeUrl;
          self.laterTime = config.androidLaterTime || 3000;
          self.package = config.package || 'com.taobao.taobao';
        }
        //只有android下的chrome要用intent协议唤起native
        if (self.platform != 'ios' && !!navigator.userAgent.match(/Chrome/i)) {
            self._hackChrome();
        } else {
            self._gotoNative();
        }
    },
    /**
     * _hackChrome 只有android下的chrome要用intent协议唤起native
     * @return {[type]} 
     */
    _hackChrome: function() {
      var self = this;
      var startTime = Date.now();
      var paramUrlarr = self.nativeUrl.split('://'),
          scheme = paramUrlarr[0],
          schemeUrl = paramUrlarr[1];
      window.location = 'intent://' + schemeUrl + '#Intent;scheme=' + scheme + ';package=' + self.package + ';end';
      setTimeout(function() {
          self._gotoDownload(startTime);
      }, self.openTime);
    },
    /**
     * [_gotoNative 跳转至native，native超时打不开就去下载]
     * @return 
     */
    _gotoNative: function() {
        var self = this;
        var startTime = Date.now(),
            doc = document,
            body = doc.body,
            iframe = doc.createElement('iframe');
            iframe.id = 'J_redirectNativeFrame';
            iframe.style.display = 'none';
            iframe.src = self.nativeUrl;

        //运行在head中
        if(!body) {
            setTimeout(function(){
                doc.body.appendChild(iframe);
            }, 0);
        } else {
            body.appendChild(iframe);
        }
        
        setTimeout(function() {
            doc.body.removeChild(iframe);
            self._gotoDownload(startTime);
            /**
             * 测试时间设置小于800ms时，在android下的UC浏览器会打开native app时并下载apk，
             * 测试android+UC下打开native的时间最好大于800ms;
             */
        }, self.openTime);
    },
    /**
     * [_gotoInstall 去下载]
     * @param  {[type]} startTime [开始时间]
     * @return 
     */
    _gotoDownload: function(startTime) {
        var self = this;
        var endTime = Date.now();
        if (endTime - startTime < self.laterTime + 500) {
            window.location = self.installUrl;
        }
    },
    /**
     * [_UA 检测平台]
     * @return string [ios|android| ]
     */
    _UA: function() {
        var ua = navigator.userAgent;
        // ios
        if (!!ua.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)) {
            return 'ios';
        } else if (!!ua.match(/Android/i)) {
            return 'android';
        } else {
            return '';
        }
    }
}
  //透传参数
var searchStr = location.search,
    iosNativeUrl = 'etao://home' + searchStr,
    andriodNativeUrl = 'etao://home' + searchStr,
    downloadUrl = 'http://m.etao.com/download.php' + searchStr,
    configObj = {
      iosInstallUrl: downloadUrl,
      androidInstallUrl: downloadUrl,
      iosNativeUrl: iosNativeUrl,
      andriodNativeUrl: andriodNativeUrl,
      package: 'com.taobao.etao'
  };

//等埋点发送好了再跳转
setTimeout(function(){
  RedirectToNative.init(configObj);
}, 50);

</script>
</body>
</html>

<!--
<script>

/**
 * @fileoverview 
 * @author miaojing<miaojing@taobao.com>
 * @module redirectToNative 移动页面或中间跳转页面使用 不依赖任何kissy模块
 **/

    var RedirectToNative = {
        init: function(cfg) {
            var self = this;
                self.platform = self._UA();
            // pc下 什么都不处理  
            if (!self.platform) return;
            var config = cfg || {
                    iosInstallUrl: '',
                    androidInstallUrl: '',
                    iosNativeUrl: '',
                    andriodNativeUrl: ''
                };
            if (self.platform == 'ios') {
              self.installUrl = config.iosInstallUrl;
              self.nativeUrl = config.iosNativeUrl;
              self.laterTime = 800;
            } else {
              self.installUrl = config.androidInstallUrl;
              self.nativeUrl = config.andriodNativeUrl;
              self.laterTime = 3000;
            }
            self._gotoNative();
        },
        /**
         * [_gotoNative 跳转至native，native超时打不开就去下载]
         * @return 
         */
        _gotoNative: function() {
            var self = this;
            var startTime = Date.now(),
                doc = document,
                body = doc.body,
                iframe = doc.createElement('iframe');
                iframe.id = 'J_redirectNativeFrame';
                iframe.style.display = 'none';
                iframe.src = self.nativeUrl;
            //运行在head中
            if(!body) {
                setTimeout(function(){
                    doc.body.appendChild(iframe);
                }, 0);
            } else {
                body.appendChild(iframe);
            }
            
            setTimeout(function() {
                doc.body.removeChild(iframe);
                self._gotoInstall(startTime);
                /**
                 * 测试时间设置小于800ms时，在android下的UC浏览器会打开native app时并下载apk，
                 * 测试android+UC下打开native的时间最好大于800ms;
                 */
            }, self.laterTime);
        },
        /**
         * [_gotoInstall 去下载]
         * @param  {[type]} startTime [开始时间]
         * @return 
         */
        _gotoInstall: function(startTime) {
            var self = this;
            var endTime = Date.now();
            if (endTime - startTime < self.laterTime + 500) {
                window.location = self.installUrl;
            }
        },
        /**
         * [_UA 检测平台]
         * @return string [ios|android| ]
         */
        _UA: function() {
            var ua = navigator.userAgent;
            // ios
            if (!!ua.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)) {
                return 'ios';
            } else if (!!ua.match(/Android/i)) {
                return 'android';
            } else {
                return '';
            }
        }
    };
  //透传参数
var searchStr = location.search,
    iosNativeUrl = 'etao://item' + searchStr,
    andriodNativeUrl = 'etao://item' + searchStr,
    iosInstallUrl = 'http://m.etao.com/download.php' + searchStr,
    androidInstallUrl = iosInstallUrl;

RedirectToNative.init({
    iosInstallUrl: iosInstallUrl,
    androidInstallUrl: androidInstallUrl,
    iosNativeUrl: iosNativeUrl,
    andriodNativeUrl: andriodNativeUrl
});

</script>
-->